name: Valhalla Ubuntu Build
on: [push]

jobs:
  build:
    name: Ubuntu build
    runs-on: ${{ matrix.os }}

    strategy:
        fail-fast: false
        matrix:
          os: [ubuntu-latest]
          # OFF works on all
          # ON compiles
          tools: [ON, OFF]
          # datatools ON needs spatialite
          datatools: [OFF]
          # services ON needs libprime_server
          services: [OFF]
          # ON  compiles, 
          ccache: [ON, OFF]
          # ON  compiles, 
          tests: [ON, OFF]
          benchmarks: [ON, OFF]

    steps:
      - uses: actions/checkout@v2
      - name: Cache submodules
        id: cache-third_party
        uses: actions/cache@v3
        with:
          path: third_party
          key: ${{ runner.os }}-third_party
      - name: Get dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            curl libcurl4 libcurl4-gnutls-dev \
            libboost-all-dev \
            libluajit-5.1-dev \
            protobuf-compiler \
            libgeos++-dev \
            libprotobuf-dev \
            protobuf-compiler
          #mlocate \
          #apt list --installed | grep curl  
          #sudo updatedb
          #locate libcurl.so
          #locate curl.h
      - name: Checkout submodules
        if: steps.cache-third_party.outputs.cache-hit != 'true'
        shell: bash
        run: |
          auth_header="$(git config --local --get http.https://github.com/.extraheader)"
          git submodule sync --recursive
          git -c "http.extraheader=$auth_header" -c protocol.version=2 submodule update --init --force --recursive --depth=1
      - name: Configure
        run: |
          mkdir build && cd build \
          && cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DENABLE_TOOLS=${{ matrix.tools }} \
            -DENABLE_DATA_TOOLS=${{ matrix.datatools }} \
            -DENABLE_SERVICES=${{ matrix.services }} \
            -DENABLE_CCACHE=${{ matrix.ccache }} \
            -DENABLE_TESTS=${{ matrix.tests }} \
            -DENABLE_BENCHMARKS=${{ matrix.benchmarks }}
      - name: run build
        run: |
          cd build \
          && make -j$(nproc)

      - name: compile benchmark
        if: ${{ matrix.benchmarks  == 'ON' }}
        run: |
          cd build \
          && make benchmark
